#!/bin/bash
# ActiveCampaign CLI wrapper for Moltbot
# Usage: activecampaign <resource> <action> [args...]

set -euo pipefail

# Load credentials with fallback chain:
# 1. Environment variables
# 2. Config files (~/.config/activecampaign/)

load_credentials() {
  # Check environment variables first
  if [ -n "${ACTIVECAMPAIGN_URL:-}" ] && [ -n "${ACTIVECAMPAIGN_API_KEY:-}" ]; then
    return 0
  fi

  # Fall back to config files
  local config_dir="${HOME}/.config/activecampaign"
  if [ -f "$config_dir/url" ] && [ -f "$config_dir/api_key" ]; then
    ACTIVECAMPAIGN_URL=$(cat "$config_dir/url")
    ACTIVECAMPAIGN_API_KEY=$(cat "$config_dir/api_key")
    export ACTIVECAMPAIGN_URL ACTIVECAMPAIGN_API_KEY
    return 0
  fi

  return 1
}

# Load field configuration
load_field_config() {
  local config_dir="${HOME}/.config/activecampaign"
  local fields_file="$config_dir/fields.json"

  if [ -f "$fields_file" ]; then
    # Check if jq is available for JSON parsing
    if command -v jq &>/dev/null; then
      FIELD_CONFIG="$fields_file"
      return 0
    fi
  fi

  # Fall back to sample config in skill directory
  local skill_dir="$(dirname "$0")/.."
  local sample_file="$skill_dir/activecampaign-fields-sample.json"

  if [ -f "$sample_file" ]; then
    FIELD_CONFIG="$sample_file"
    return 0
  fi

  return 1
}

# Get field ID from config
get_field_id() {
  local field_path="$1"
  if [ -n "${FIELD_CONFIG:-}" ] && command -v jq &>/dev/null; then
    jq -r ".${field_path} // empty" "$FIELD_CONFIG" 2>/dev/null || echo ""
  fi
}

if ! load_credentials; then
  echo "Error: Missing ActiveCampaign credentials" >&2
  echo "" >&2
  echo "Set credentials via one of:" >&2
  echo "  1. Environment variables:" >&2
  echo "     export ACTIVECAMPAIGN_URL=\"https://youraccount.api-us1.com\"" >&2
  echo "     export ACTIVECAMPAIGN_API_KEY=\"your-api-key\"" >&2
  echo "" >&2
  echo "  2. Config files:" >&2
  echo "     mkdir -p ~/.config/activecampaign" >&2
  echo "     echo \"https://youraccount.api-us1.com\" > ~/.config/activecampaign/url" >&2
  echo "     echo \"your-api-key\" > ~/.config/activecampaign/api_key" >&2
  exit 1
fi

# Clean trailing slash
ACTIVECAMPAIGN_URL="${ACTIVECAMPAIGN_URL%/}"

BASE_URL="$ACTIVECAMPAIGN_URL/admin/api.php"
API_VERSION="3"

# Rate limiting: 5 req/sec = 200ms between requests
RATE_DELAY="0.2"

# Helper function for API calls
ac_api() {
  local method="$1"
  local endpoint="$2"
  local data="${3:-}"

  # Rate limit
  sleep "$RATE_DELAY"

  local curl_args=(-X "$method" "-H" "Api-Token: $ACTIVECAMPAIGN_API_KEY" "-H" "Content-Type: application/json")

  if [ -n "$data" ]; then
    curl_args+=("-d" "$data")
  fi

  curl -s "${curl_args[@]}" "$BASE_URL?api_version=$API_VERSION&api_output=json&api_action=$endpoint"
}

# Parse resource and action
RESOURCE="$1"
ACTION="$2"
shift 2

case "$RESOURCE" in
  contacts)
    case "$ACTION" in
      list)
        # List all contacts with pagination
        ac_api GET "contact_list" "list=100&page=1"
        ;;
      create)
        local email="$1"
        local firstName="${2:-}"
        local lastName="${3:-}"
        local data="{\"contact\":{\"email\":\"$email\",\"firstName\":\"$firstName\",\"lastName\":\"$lastName\"}}"
        ac_api POST "contact_add" "$data"
        ;;
      sync)
        # Create or update contact
        local email="$1"
        local firstName="${2:-}"
        local lastName="${3:-}"
        local data="{\"contact\":{\"email\":\"$email\",\"firstName\":\"$firstName\",\"lastName\":\"$lastName\"}}"
        ac_api POST "contact_sync" "$data"
        ;;
      get)
        local id="$1"
        ac_api GET "contact_view&id=$id"
        ;;
      search)
        local query="$1"
        ac_api GET "contact_list&query=$query"
        ;;
      add-tag)
        local contact_id="$1"
        local tag_id="$2"
        local data="{\"contactTag\":{\"contact\":\"$contact_id\",\"tag\":\"$tag_id\"}}"
        ac_api POST "contact_tag_add" "$data"
        ;;
      remove-tag)
        local contact_id="$1"
        local tag_id="$2"
        ac_api GET "contact_tag_remove&contact=$contact_id&tag=$tag_id"
        ;;
      *)
        echo "Usage: activecampaign contacts <list|create|sync|get|search|add-tag|remove-tag> [args...]"
        exit 1
        ;;
    esac
    ;;

  deals)
    case "$ACTION" in
      list)
        ac_api GET "deal_list"
        ;;
      create)
        local title="$1"
        local stage="$2"
        local value="${3:-0}"
        local data="{\"deal\":{\"title\":\"$title\",\"stage\":\"$stage\",\"value\":\"$value\"}}"
        ac_api POST "deal_add" "$data"
        ;;
      get)
        local id="$1"
        ac_api GET "deal_view&id=$id"
        ;;
      update)
        local id="$1"
        shift
        # Parse remaining args for update fields
        local data="{\"deal\":{\"id\":\"$id\""
        while [ $# -gt 0 ]; do
          local key="$1"
          local val="$2"
          data="$data,\"$key\":\"$val\""
          shift 2
        done
        data="$data}"
        ac_api POST "deal_edit" "$data"
        ;;
      *)
        echo "Usage: activecampaign deals <list|create|get|update> [args...]"
        exit 1
        ;;
    esac
    ;;

  tags)
    case "$ACTION" in
      list)
        ac_api GET "tags_list"
        ;;
      create)
        local name="$1"
        local data="{\"tag\":{\"name\":\"$name\"}}"
        ac_api POST "tag_add" "$data"
        ;;
      sync)
        # Sync/add tag to contact (alias for contacts add-tag)
        local contact_id="$1"
        local tag_id="$2"
        local data="{\"contactTag\":{\"contact\":\"$contact_id\",\"tag\":\"$tag_id\"}}"
        ac_api POST "contact_tag_add" "$data"
        ;;
      *)
        echo "Usage: activecampaign tags <list|create|sync> [args...]"
        exit 1
        ;;
    esac
    ;;

  automations)
    case "$ACTION" in
      list)
        ac_api GET "automation_list"
        ;;
      get)
        local id="$1"
        ac_api GET "automation_view&id=$id"
        ;;
      add-contact)
        local contact_id="$1"
        local automation_id="$2"
        local data="{\"contactAutomation\":{\"contact\":\"$contact_id\",\"automation\":\"$automation_id\"}}"
        ac_api POST "contact_automation_add" "$data"
        ;;
      remove-contact)
        local contact_id="$1"
        local automation_id="$2"
        ac_api GET "contact_automation_remove&contact=$contact_id&automation=$automation_id"
        ;;
      *)
        echo "Usage: activecampaign automations <list|get|add-contact|remove-contact> [args...]"
        exit 1
        ;;
    esac
    ;;

  pipelines)
    case "$ACTION" in
      list)
        ac_api GET "pipeline_list"
        ;;
      get)
        local id="$1"
        ac_api GET "pipeline_view&id=$id"
        ;;
      *)
        echo "Usage: activecampaign pipelines <list|get> [args...]"
        exit 1
        ;;
    esac
    ;;

  stages)
    case "$ACTION" in
      list)
        ac_api GET "stage_list"
        ;;
      get)
        local id="$1"
        ac_api GET "stage_view&id=$id"
        ;;
      *)
        echo "Usage: activecampaign stages <list|get> [args...]"
        exit 1
        ;;
    esac
    ;;

  fields)
    case "$ACTION" in
      list)
        # Load field config and display available fields
        if load_field_config; then
          echo "=== ActiveCampaign Field Configuration ==="
          echo ""
          if command -v jq &>/dev/null && [ -n "${FIELD_CONFIG:-}" ]; then
            echo "Using config: $FIELD_CONFIG"
            echo ""
            echo "Order Fields:"
            jq -r '.order_fields | to_entries[] | "  \(.key): \(.value)"' "$FIELD_CONFIG" 2>/dev/null || true
            echo ""
            echo "Shipping Fields:"
            jq -r '.shipping_fields | to_entries[] | "  \(.key): \(.value)"' "$FIELD_CONFIG" 2>/dev/null || true
            echo ""
            echo "Billing Fields:"
            jq -r '.billing_fields | to_entries[] | "  \(.key): \(.value)"' "$FIELD_CONFIG" 2>/dev/null || true
            echo ""
            echo "Subscription Fields:"
            jq -r '.subscription_fields | to_entries[] | "  \(.key): \(.value)"' "$FIELD_CONFIG" 2>/dev/null || true
            echo ""
            echo "Additional Fields:"
            jq -r '.additional_fields | to_entries[] | "  \(.key): \(.value)"' "$FIELD_CONFIG" 2>/dev/null || true
          else
            cat "$FIELD_CONFIG"
          fi
        else
          echo "Error: No field configuration found" >&2
          echo "Create ~/.config/activecampaign/fields.json or use the sample config" >&2
          exit 1
        fi
        ;;
      get)
        local field_name="$1"
        if load_field_config; then
          get_field_id "$field_name"
        else
          echo "Error: No field configuration found" >&2
          exit 1
        fi
        ;;
      set-field)
        # Set a custom field value on a contact
        local contact_id="$1"
        local field_id="$2"
        local value="$3"
        local data="{\"fieldValue\":{\"contact\":\"$contact_id\",\"field\":\"$field_id\",\"value\":\"$value\"}}"
        ac_api POST "fieldValue_add" "$data"
        ;;
      *)
        echo "Usage: activecampaign fields <list|get|set-field> [args...]"
        echo ""
        echo "Examples:"
        echo "  activecampaign fields list                    # List all configured fields"
        echo "  activecampaign fields get order_fields.order_id  # Get specific field ID"
        echo "  activecampaign fields set-field <contact_id> <field_id> <value>"
        exit 1
        ;;
    esac
    ;;

  lists)
    case "$ACTION" in
      list)
        ac_api GET "lists_list"
        ;;
      get)
        local id="$1"
        ac_api GET "list_view&id=$id"
        ;;
      add-contact)
        local list_id="$1"
        local contact_id="$2"
        local data="{\"listContact\":{\"list\":\"$list_id\",\"contact\":\"$contact_id\"}}"
        ac_api POST "list_contact_add" "$data"
        ;;
      remove-contact)
        local list_id="$1"
        local contact_id="$2"
        ac_api GET "list_contact_remove&list=$list_id&contact=$contact_id"
        ;;
      *)
        echo "Usage: activecampaign lists <list|get|add-contact|remove-contact> [args...]"
        exit 1
        ;;
    esac
    ;;

  config)
    case "$ACTION" in
      init)
        # Create sample config file
        local config_dir="${HOME}/.config/activecampaign"
        local sample_file="$(dirname "$0")/../activecampaign-fields-sample.json"
        local target_file="$config_dir/fields.json"

        mkdir -p "$config_dir"

        if [ -f "$target_file" ]; then
          echo "Config already exists at $target_file"
          echo "Remove it first if you want to regenerate."
          exit 1
        fi

        if [ -f "$sample_file" ]; then
          cp "$sample_file" "$target_file"
          echo "Created $target_file from sample"
          echo "Edit it with your ActiveCampaign field IDs."
        else
          echo "Error: Sample config not found" >&2
          exit 1
        fi
        ;;
      path)
        echo "${HOME}/.config/activecampaign/fields.json"
        ;;
      sample-path)
        echo "$(dirname "$0")/../activecampaign-fields-sample.json"
        ;;
      *)
        echo "Usage: activecampaign config <init|path|sample-path>"
        echo ""
        echo "Commands:"
        echo "  init         - Create ~/.config/activecampaign/fields.json from sample"
        echo "  path         - Show path to user config file"
        echo "  sample-path  - Show path to sample config in skill directory"
        exit 1
        ;;
    esac
    ;;

  *)
    echo "ActiveCampaign CLI"
    echo ""
    echo "Usage: activecampaign <resource> <action> [args...]"
    echo ""
    echo "Resources:"
    echo "  contacts   - Manage leads and contacts"
    echo "  deals      - Sales pipeline deals"
    echo "  tags       - Contact tagging"
    echo "  automations - Email automation triggers"
    echo "  pipelines  - Deal pipelines"
    echo "  stages     - Pipeline stages"
    echo "  fields     - Custom field operations"
    echo "  lists      - Contact list management"
    echo "  config     - Configuration management"
    echo ""
    echo "Examples:"
    echo "  activecampaign contacts list"
    echo "  activecampaign contacts sync \"email@test.com\" \"John\" \"Doe\""
    echo "  activecampaign deals create \"Clinic Name\" 1 5000"
    echo "  activecampaign tags list"
    echo "  activecampaign fields list"
    echo "  activecampaign config init"
    echo ""
    exit 1
    ;;
esac
